C
C     nfseg.springflow.f
C
C     Evaluate springflow simulated by GHBs for MODFLOW-2005-NWT ECFTX GW Flow Model - 2001 and 2009 Steady-State Simulation 
C

	PARAMETER(NROW=752,NCOL=704,NLAY=7,NSP=2,NSPR = 379)
	CHARACTER TEXT1*16,MEMO*5
	INTEGER IT1,IT2,NC,NR,NL
        DIMENSION XVS(NCOL,NROW,NLAY,NSP),COND(NSPR)

C	READ SIMULATED HEADS
	WRITE(*,*)"READ NFSEG BINARY HEAD FILE"
	OPEN(10,FILE='nfseg_all_to_cbc.hds',FORM='BINARY',STATUS='OLD')
	DO ISP=1,NSP
	 DO ILAY=1,NLAY
	 READ(10) IT1,IT2,PERTIM,TOTIM,TEXT1,NC,NR,IL
	 print*, IT1,IT2,PERTIM,TOTIM,TEXT1,NC,NR,IL
	 READ(10) XVS(:,:,ILAY,ISP)
	 ENDDO
	ENDDO
	CLOSE(10)

C	READ SPRING CONDUCTANCES
	WRITE(*,*)"READ SPRING CONDUCTANCE ESTIMATES"
	OPEN(11,FILE='gwv_springs_conductances.dat',STATUS='OLD')
	READ(11,*)
	DO I=1,NSPR
	READ(11,*)ISPRINGREACH,COND(I)
	WRITE(*,*)"SPRING REACHID: ", ISPRINGREACH,"COND = ", COND(I)

	ENDDO
	CLOSE(11)

C	EVALUATE SPRINGFLOW
	WRITE(*,*)"EVALUATE SPRINGFLOW"
	OPEN(12,FILE='nfseg.springs.csv',STATUS='OLD')
      OPEN(13,FILE='nfseg.springflow.dat',STATUS='UNKNOWN')
C
	READ(12,*)
	WRITE(13,108)'SPREACHID','LAYER','ROW','COLUMN',
     * 'SPELEV01','SPELEV09',
     * 'COND','CFD_SP01','CFD_SP09'

	SUMSPRNFLOW01_L2_IN = 0.
	SUMSPRNFLOW01_L3_IN = 0.
	SUMSPRNFLOW09_L2_IN = 0.
	SUMSPRNFLOW09_L3_IN = 0.

	SUMSPRNFLOW01_L2_OUT = 0.
	SUMSPRNFLOW01_L3_OUT = 0.
	SUMSPRNFLOW09_L2_OUT = 0.
	SUMSPRNFLOW09_L3_OUT = 0.


        DO  I=1,NSPR
	READ(12,*)ISPRINGREACH,ILAY,IROW,ICOL,SPELEV01,SPELEV09
	SPRINGFLOW01 = COND(I)*(SPELEV01-XVS(ICOL,IROW,ILAY,1))
	SPRINGFLOW09 = COND(I)*(SPELEV09-XVS(ICOL,IROW,ILAY,2))
      WRITE(13,109)ISPRINGREACH,ILAY,IROW,ICOL,
     &	SPELEV01,SPELEV09,COND(I),
     &	SPRINGFLOW01,SPRINGFLOW09
      WRITE(*,*)ISPRINGREACH,ILAY,IROW,ICOL,
     &	SPELEV01,SPELEV09,COND(I),
     &	SPRINGFLOW01,SPRINGFLOW09
	IF(ILAY.EQ.2)THEN

	IF(SPRINGFLOW01.LT.0.)THEN
	SUMSPRNFLOW01_L2_OUT = SUMSPRNFLOW01_L2_OUT - SPRINGFLOW01
	ELSE
	SUMSPRNFLOW01_L2_IN  = SUMSPRNFLOW01_L2_IN  + SPRINGFLOW01
	ENDIF

	IF(SPRINGFLOW09.LT.0.)THEN
	SUMSPRNFLOW09_L2_OUT = SUMSPRNFLOW09_L2_OUT - SPRINGFLOW09
	ELSE
	SUMSPRNFLOW09_L2_IN  = SUMSPRNFLOW09_L2_IN  + SPRINGFLOW09
	ENDIF

	ENDIF

	IF(ILAY.EQ.3)THEN

	IF(SPRINGFLOW01.LT.0.)THEN
	SUMSPRNFLOW01_L3_OUT = SUMSPRNFLOW01_L3_OUT - SPRINGFLOW01
	ELSE
	SUMSPRNFLOW01_L3_IN  = SUMSPRNFLOW01_L3_IN  + SPRINGFLOW01
	ENDIF

	IF(SPRINGFLOW09.LT.0.)THEN
	SUMSPRNFLOW09_L3_OUT = SUMSPRNFLOW09_L3_OUT - SPRINGFLOW09
	ELSE
	SUMSPRNFLOW09_L3_IN  = SUMSPRNFLOW09_L3_IN  + SPRINGFLOW09
	ENDIF

	ENDIF
        END DO

	CLOSE(12)
	CLOSE(13)

	OPEN(14,FILE='nfseg.springflow.table.2001.dat',STATUS='UNKNOWN')
	WRITE(14,20)'LAYER','SPRINGS_inflow','SPRINGS_outflow'
      WRITE(14,30)1,0.,0.
      WRITE(14,30)2,SUMSPRNFLOW01_L2_IN, SUMSPRNFLOW01_L2_OUT
      WRITE(14,30)3, SUMSPRNFLOW01_L3_IN, SUMSPRNFLOW01_L3_OUT
	WRITE(14,30)4,0.,0.
	WRITE(14,30)5,0.,0.
	WRITE(14,30)6,0.,0.
	WRITE(14,30)7,0.,0.
	CLOSE(14)

	OPEN(15,FILE='nfseg.springflow.table.2009.dat',STATUS='UNKNOWN')
	WRITE(15,20)'LAYER','SPRINGS_inflow','SPRINGS_outflow'
	WRITE(15,30)1,0.,0.
      WRITE(15,30)2,SUMSPRNFLOW09_L2_IN, SUMSPRNFLOW09_L2_OUT
      WRITE(15,30)3,SUMSPRNFLOW09_L3_IN, SUMSPRNFLOW09_L3_OUT
	WRITE(15,30)4,0.,0.
	WRITE(15,30)5,0.,0.
	WRITE(15,30)6,0.,0.
	WRITE(15,30)7,0.,0.
	CLOSE(15)
C
C     WRITE FORMATS
C

20	FORMAT(A5,30A30)
30	FORMAT(I5,30F30.0,I20)
108	FORMAT(4A10,2A10,3A20)
109   FORMAT(4I10,2F10.2,3E20.11)

C

	STOP
	END
